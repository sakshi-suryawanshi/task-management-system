services:
  # MySQL Database Service
  db:
    image: mysql:8.0
    container_name: taskmanager_db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-taskmanager}
      MYSQL_USER: ${MYSQL_USER:-taskuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-taskpass}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpass}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - taskmanager_network
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  # Redis Service (Cache & Message Broker)
  redis:
    image: redis:7-alpine
    container_name: taskmanager_redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - taskmanager_network
    command: redis-server --appendonly yes

  # Django Application Service
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: taskmanager_web
    restart: unless-stopped
    command: >
      sh -c "python manage.py collectstatic --noinput &&
             gunicorn taskmanager.wsgi:application 
             --bind 0.0.0.0:8000 
             --workers ${GUNICORN_WORKERS:-3} 
             --threads ${GUNICORN_THREADS:-2} 
             --timeout 120 
             --access-logfile - 
             --error-logfile -"
    volumes:
      - .:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    ports:
      - "${DJANGO_PORT:-8000}:8000"
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - DEBUG=${DEBUG:-True}
      - DATABASE_URL=mysql://${MYSQL_USER:-taskuser}:${MYSQL_PASSWORD:-taskpass}@db:3306/${MYSQL_DATABASE:-taskmanager}
      - MYSQL_HOST=db
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=${MYSQL_DATABASE:-taskmanager}
      - MYSQL_USER=${MYSQL_USER:-taskuser}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-taskpass}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - taskmanager_network

  # Celery Worker Service
  celery:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: taskmanager_celery
    restart: unless-stopped
    command: celery -A taskmanager worker -l ${CELERY_LOG_LEVEL:-INFO} --concurrency=${CELERY_CONCURRENCY:-4}
    volumes:
      - .:/app
      - media_volume:/app/media
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_started
    environment:
      - DEBUG=${DEBUG:-True}
      - DATABASE_URL=mysql://${MYSQL_USER:-taskuser}:${MYSQL_PASSWORD:-taskpass}@db:3306/${MYSQL_DATABASE:-taskmanager}
      - MYSQL_HOST=db
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=${MYSQL_DATABASE:-taskmanager}
      - MYSQL_USER=${MYSQL_USER:-taskuser}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-taskpass}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    networks:
      - taskmanager_network

  # Celery Beat Service (Task Scheduler)
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: taskmanager_celery_beat
    restart: unless-stopped
    command: celery -A taskmanager beat -l ${CELERY_LOG_LEVEL:-INFO}
    volumes:
      - .:/app
      - celerybeat_data:/app/celerybeat-schedule
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      celery:
        condition: service_started
    environment:
      - DEBUG=${DEBUG:-True}
      - DATABASE_URL=mysql://${MYSQL_USER:-taskuser}:${MYSQL_PASSWORD:-taskpass}@db:3306/${MYSQL_DATABASE:-taskmanager}
      - MYSQL_HOST=db
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=${MYSQL_DATABASE:-taskmanager}
      - MYSQL_USER=${MYSQL_USER:-taskuser}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-taskpass}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    networks:
      - taskmanager_network

  # Flower Service (Celery Monitoring Dashboard)
  flower:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: taskmanager_flower
    restart: unless-stopped
    command: >
      sh -c "
      if [ \"$$FLOWER_ENABLE_AUTH\" = \"true\" ]; then
        celery -A taskmanager flower --port=5555 --broker=redis://redis:6379/0 --broker_api=redis://redis:6379/0 --persistent=True --db=/tmp/flower.db --max_tasks=10000 --basic_auth=$$FLOWER_USER:$$FLOWER_PASSWORD;
      else
        celery -A taskmanager flower --port=5555 --broker=redis://redis:6379/0 --broker_api=redis://redis:6379/0 --persistent=True --db=/tmp/flower.db --max_tasks=10000;
      fi
      "
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    volumes:
      - .:/app
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
      celery:
        condition: service_started
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - FLOWER_PORT=${FLOWER_PORT:-5555}
      - FLOWER_ENABLE_AUTH=${FLOWER_ENABLE_AUTH:-false}
      - FLOWER_USER=${FLOWER_USER:-admin}
      - FLOWER_PASSWORD=${FLOWER_PASSWORD:-admin}
      - FLOWER_UNAUTHENTICATED_API=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - taskmanager_network

  # Nginx Service (Reverse Proxy & Static File Server)
  nginx:
    image: nginx:alpine
    container_name: taskmanager_nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - static_volume:/var/www/static:ro
      - media_volume:/var/www/media:ro
    depends_on:
      web:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - taskmanager_network

# Named Volumes for Data Persistence
volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local
  celerybeat_data:
    driver: local
  flower_data:
    driver: local

# Docker Network
networks:
  taskmanager_network:
    driver: bridge

