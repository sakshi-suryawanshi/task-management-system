# Nginx configuration for Task Management System
# Production-ready configuration with comprehensive features:
# - Static file serving with caching
# - Reverse proxy to Gunicorn (Django)
# - CORS headers support
# - Security headers
# - Performance optimizations (gzip, caching)
# - Proper error handling
#
# For more information about Nginx configuration, see:
# https://nginx.org/en/docs/

# Upstream server for Django application (Gunicorn)
# This defines the backend server that Nginx will proxy requests to
upstream django {
    server web:8000;
    
    # Optional: Add multiple servers for load balancing
    # server web:8000 weight=1;
    # server web:8001 weight=1 backup;
    
    # Optional: Connection keep-alive for better performance
    keepalive 32;
}

# Main server block
server {
    # Listen on port 80 (HTTP)
    listen 80;
    
    # Server name (can be changed via environment variable in production)
    server_name localhost;
    
    # Maximum allowed size for client request body (for file uploads)
    # 100M is reasonable for file attachments in task management system
    client_max_body_size 100M;
    
    # Buffer size for reading client request body
    client_body_buffer_size 128k;
    
    # Timeout for reading client request body
    client_body_timeout 60s;
    
    # Timeout for reading client request header
    client_header_timeout 60s;
    
    # Maximum size of client request headers
    large_client_header_buffers 4 16k;
    
    # Disable server tokens (hide Nginx version in headers)
    server_tokens off;
    
    # Charset
    charset utf-8;
    
    # Root directory (not used for proxy, but defined for completeness)
    root /var/www;
    
    # Logging configuration
    # Note: log_format must be defined in http context, not server context
    # Using default log format for simplicity (can be customized in main nginx.conf if needed)
    # Access log with default format
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
    
    # Gzip compression configuration
    # Enable gzip compression for text-based files to reduce bandwidth
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    gzip_min_length 1000;
    gzip_disable "msie6";
    
    # ============================================================================
    # Static Files Configuration
    # ============================================================================
    # Serve static files directly from Nginx (better performance than Django)
    # Static files are collected via 'python manage.py collectstatic'
    
    location /static/ {
        alias /var/www/static/;
        
        # Cache static files for 30 days
        expires 30d;
        
        # Cache control headers
        add_header Cache-Control "public, immutable";
        
        # Optional: Add CORS headers for static assets if needed
        # add_header Access-Control-Allow-Origin "*" always;
        
        # Security headers for static files
        add_header X-Content-Type-Options "nosniff" always;
        
        # Enable gzip compression for static files
        gzip_static on;
        
        # Logging (optional, can disable for performance)
        access_log off;
    }
    
    # ============================================================================
    # Media Files Configuration
    # ============================================================================
    # Serve media files (user uploads) directly from Nginx
    
    location /media/ {
        alias /var/www/media/;
        
        # Cache media files for 7 days (user uploads may change)
        expires 7d;
        
        # Cache control headers
        add_header Cache-Control "public";
        
        # Security headers
        add_header X-Content-Type-Options "nosniff" always;
        
        # Disable directory listing for security
        autoindex off;
    }
    
    # ============================================================================
    # Health Check Endpoints
    # ============================================================================
    # Health check endpoints (used by Docker health checks, load balancers, and monitoring)
    # Disable access logging for health checks to reduce log noise
    # These endpoints are critical for monitoring and should be fast and reliable
    
    # Overall health check (checks all services)
    location /health/ {
        proxy_pass http://django;
        
        # Basic proxy headers
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering for health checks (get response immediately)
        proxy_buffering off;
        
        # Short timeouts for health checks (fail fast)
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        
        # Disable access logging for health checks (reduce log noise)
        access_log off;
        
        # Cache control (no caching for health checks)
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }
    
    # Database health check endpoint
    location /health/db/ {
        proxy_pass http://django;
        
        # Basic proxy headers
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering
        proxy_buffering off;
        
        # Short timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        
        # Disable access logging
        access_log off;
        
        # Cache control
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }
    
    # Redis health check endpoint
    location /health/redis/ {
        proxy_pass http://django;
        
        # Basic proxy headers
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering
        proxy_buffering off;
        
        # Short timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        
        # Disable access logging
        access_log off;
        
        # Cache control
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }
    
    # ============================================================================
    # API Endpoints Configuration
    # ============================================================================
    # Proxy all API requests to Django/Gunicorn
    
    location /api/ {
        # Proxy to upstream Django server
        proxy_pass http://django;
        
        # Essential proxy headers
        # These headers ensure Django receives correct client information
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Connection settings
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Redirect settings
        proxy_redirect off;
        
        # Timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering settings (disable for real-time responses, enable for performance)
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # CORS Headers (handled by Django CORS middleware, but OPTIONS preflight can be handled here)
        # Note: Django's django-cors-headers middleware handles CORS for most cases
        # This OPTIONS handling is optional and can be removed if Django handles it
        # 
        # For preflight OPTIONS requests, return CORS headers
        # if ($request_method = 'OPTIONS') {
        #     add_header 'Access-Control-Allow-Origin' '*' always;
        #     add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        #     add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-CSRFToken' always;
        #     add_header 'Access-Control-Max-Age' 1728000 always;
        #     add_header 'Content-Type' 'text/plain; charset=utf-8' always;
        #     add_header 'Content-Length' 0 always;
        #     return 204;
        # }
        #
        # Note: CORS is better handled by Django's django-cors-headers middleware
        # because it can be configured per-view and respects CORS_ALLOWED_ORIGINS
        # Uncomment the above block only if you need Nginx-level CORS handling
    }
    
    # ============================================================================
    # Admin Panel Configuration
    # ============================================================================
    # Django admin panel (requires authentication)
    
    location /admin/ {
        proxy_pass http://django;
        
        # Essential proxy headers
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        
        # Connection settings
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Redirect settings
        proxy_redirect off;
        
        # Timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        
        # Security: Add X-Frame-Options for admin panel
        add_header X-Frame-Options "SAMEORIGIN" always;
    }
    
    # ============================================================================
    # API Documentation and Token Endpoints
    # ============================================================================
    # Note: API documentation (/api/docs/, /api/schema/, /api/redoc/) and
    # JWT token endpoints (/api/token/) are handled by the general /api/ location block below.
    # All API endpoints share the same proxy configuration.
    
    # ============================================================================
    # Default Location (catch-all)
    # ============================================================================
    # All other requests are proxied to Django
    # This includes root path and any other paths not matched above
    
    location / {
        proxy_pass http://django;
        
        # Essential proxy headers
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Connection settings
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Redirect settings
        proxy_redirect off;
        
        # Timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }
    
    # ============================================================================
    # Security Headers (Global)
    # ============================================================================
    # Security headers applied to all responses
    
    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Enable XSS protection (legacy, but some browsers still use it)
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer Policy (control how much referrer information is sent)
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Permissions Policy (formerly Feature Policy)
    # Restrict access to browser features
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # Note: X-Frame-Options is set per-location (DENY for most, SAMEORIGIN for admin)
    # Note: Content-Security-Policy should be added if needed (complex, requires careful configuration)
    # Note: Strict-Transport-Security (HSTS) should be added for HTTPS (not applicable for HTTP port 80)
    
    # ============================================================================
    # Error Pages
    # ============================================================================
    # Custom error pages (optional, can be enabled if custom error pages are created)
    
    # error_page 404 /404.html;
    # error_page 500 502 503 504 /50x.html;
    # location = /50x.html {
    #     root /usr/share/nginx/html;
    # }
    
    # ============================================================================
    # Deny Access to Hidden Files
    # ============================================================================
    # Prevent access to hidden files (files starting with .)
    
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ============================================================================
    # Deny Access to Backup Files
    # ============================================================================
    # Prevent access to backup files and other sensitive files
    
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}
